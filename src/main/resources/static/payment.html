<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CatchABite Payment - PortOne V2</title>
    
    <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
    
    <style>
        /* * ê¸°ì¡´ ë””ìì¸ ìœ ì§€
         * ê¹”ë”í•œ ì¹´ë“œ í˜•íƒœì˜ ë ˆì´ì•„ì›ƒê³¼ ë°˜ì‘í˜• ë””ìì¸
         */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }
        h1 { color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { color: #666; font-size: 14px; margin-bottom: 30px; }
        .form-group { margin-bottom: 20px; }
        label { display: block; color: #333; font-weight: 600; margin-bottom: 8px; font-size: 14px; }
        input, select {
            width: 100%; padding: 12px 16px; border: 2px solid #e0e0e0;
            border-radius: 8px; font-size: 14px; transition: border-color 0.3s;
        }
        input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        input:read-only { background-color: #f5f5f5; color: #666; cursor: not-allowed; }
        
        .button-group { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 30px; }
        button {
            padding: 12px 24px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .btn-secondary { background: #f5f5f5; color: #333; }
        .btn-secondary:hover:not(:disabled) { background: #e8e8e8; }
        
        .info-box {
            background: #e3f2fd; border-left: 4px solid #2196F3;
            padding: 12px; margin-bottom: 20px; border-radius: 4px;
            font-size: 13px; color: #1565c0;
        }
        .order-section {
            background: #f9f9f9; padding: 16px; border-radius: 8px;
            margin-bottom: 20px; border: 1px solid #e0e0e0; display: none;
        }
        .order-details {
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
            background: white; padding: 12px; border-radius: 6px; margin-top: 10px;
        }
        .detail-item { border-right: 1px solid #e0e0e0; padding-right: 12px; }
        .detail-item:last-child { border-right: none; }
        .detail-label { font-size: 12px; color: #666; font-weight: 500; }
        .detail-value { font-size: 14px; color: #333; font-weight: 600; margin-top: 4px; }
        .highlight { color: #667eea; font-weight: 700; }
        
        /* ê²°ê³¼ ë° ë¡œë”© í‘œì‹œ */
        .result { margin-top: 30px; padding: 20px; border-radius: 8px; display: none; }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .result pre { background: rgba(0,0,0,0.05); padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 11px; margin-top: 10px; }
        
        .loading { display: none; text-align: center; color: #667eea; margin: 20px 0; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid #667eea;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ›’ CatchABite</h1>
    <p class="subtitle">PortOne V2 ì•ˆì „ ê²°ì œ</p>

    <div class="info-box">
        ğŸ“Œ <strong>í…ŒìŠ¤íŠ¸ ì •ë³´:</strong><br>
        Store ID ë° Channel KeyëŠ” ì„œë²„ ì„¤ì •ì—ì„œ ìë™ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤.
    </div>

    <form id="paymentForm">
        <div class="form-group">
            <label>ì£¼ë¬¸ ID (Order ID)</label>
            <input type="number" id="orderId" placeholder="ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
        </div>

        <div class="order-section" id="orderSection">
            <h3>ğŸ“¦ ì£¼ë¬¸ ìƒì„¸</h3>
            <div class="order-details">
                <div class="detail-item">
                    <div class="detail-label">êµ¬ë§¤ì</div>
                    <div class="detail-value" id="displayBuyerName">-</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">ê²°ì œ ê¸ˆì•¡</div>
                    <div class="detail-value highlight" id="displayAmount">-</div>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #888;">
                ì´ë©”ì¼: <span id="displayBuyerEmail">-</span>
            </div>
        </div>

        <div class="button-group">
            <button type="button" class="btn-secondary" onclick="resetForm()">ì´ˆê¸°í™”</button>
            <button type="button" class="btn-primary" id="payBtn" onclick="requestPortOnePayment()" disabled>
                ê²°ì œí•˜ê¸° (V2)
            </button>
        </div>
    </form>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p id="loadingText">ì²˜ë¦¬ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="result" id="result"></div>
</div>

<script>
    // ì „ì—­ ë³€ìˆ˜
    let currentOrder = null;
    let currentUser = null; // ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ì €ì¥
    let portOneConfig = {
        storeId: null,
        channelKey: null
    };

    // 1. ì´ˆê¸°í™” ë° ì„¤ì • ë¡œë“œ
    window.addEventListener('DOMContentLoaded', async () => {
        console.log("í˜ì´ì§€ ë¡œë“œë¨: PortOne V2 ì´ˆê¸°í™” ì‹œì‘");
        
        const params = new URLSearchParams(window.location.search);
        const orderIdParam = params.get('orderId');

        await loadPortOneConfig();

        if (orderIdParam) {
            document.getElementById('orderId').value = orderIdParam;
            await fetchOrderData(orderIdParam);
        }

        document.getElementById('orderId').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                fetchOrderData(e.target.value);
            }
        });
    });

    // ì„¤ì • ë¡œë“œ
    async function loadPortOneConfig() {
        try {
            const response = await fetch('/api/v1/config/portone'); 
            if (!response.ok) throw new Error("ì„¤ì • ë¡œë“œ ì‹¤íŒ¨");
            
            const data = await response.json();
            const config = data.data || data; 
            
            // í‚¤ ì´ë¦„ í˜¸í™˜ì„± ì²˜ë¦¬ (ì¹´ë©œì¼€ì´ìŠ¤ vs ì¼€ë°¥ì¼€ì´ìŠ¤)
            portOneConfig.storeId = config.storeId || config['store-id'];
            portOneConfig.channelKey = config.channelKey || config['channel-key'];
            
            console.log("ì„¤ì • ë¡œë“œ ì™„ë£Œ:", portOneConfig);
        } catch (error) {
            console.error("ì„¤ì • ë¡œë“œ ì˜¤ë¥˜:", error);
            showResult('error', 'ê²°ì œ ì„¤ì •ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ì£¼ë¬¸ ë° ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
    async function fetchOrderData(orderId) {
        if (!orderId) {
            alert('ì£¼ë¬¸ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        showLoading(true, "ì£¼ë¬¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...");
        hideResult();

        try {
            // A. ì£¼ë¬¸ ì •ë³´ ì¡°íšŒ
            const response = await fetch(`/api/v1/appuser/orders/${orderId}`);
            if (!response.ok) throw new Error(`ì£¼ë¬¸ ì¡°íšŒ ì‹¤íŒ¨ (Status: ${response.status})`);
            const json = await response.json();
            currentOrder = json.data || json;

            // B. ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ (currentUser ê°±ì‹ )
            if (currentOrder.appUserId) {
                await fetchUserData(currentOrder.appUserId);
            } else {
                console.warn("ì£¼ë¬¸ ë°ì´í„°ì— appUserIdê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
            
            updateUI();

        } catch (error) {
            console.error(error);
            showResult('error', `ì£¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${error.message}`);
            document.getElementById('orderSection').style.display = 'none';
        } finally {
            showLoading(false);
        }
    }

    // ì‚¬ìš©ì ìƒì„¸ ì •ë³´ ì¡°íšŒ
    async function fetchUserData(userId) {
        try {
            const userResp = await fetch(`/api/v1/appuser/${userId}`);
            if (userResp.ok) {
                const userJson = await userResp.json();
                currentUser = userJson.data || userJson;
                console.log("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì„±ê³µ:", currentUser);
            } else {
                console.error("ì‚¬ìš©ì ì¡°íšŒ ì‹¤íŒ¨ status:", userResp.status);
            }
        } catch (error) {
            console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì—ëŸ¬:", error);
        }
    }

    // UI ì—…ë°ì´íŠ¸
    function updateUI() {
        if (!currentOrder) return;

        // ê²°ì œ ê¸ˆì•¡
        document.getElementById('displayAmount').textContent = `${(currentOrder.orderTotalPrice || 0).toLocaleString()}ì›`;

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ (currentUser ì‚¬ìš©)
        if (currentUser) {
            // ë¡œê·¸ ê¸°ë°˜ í•„ë“œëª…: appUserName, appUserEmail
            document.getElementById('displayBuyerName').textContent = currentUser.appUserName || "êµ¬ë§¤ì";
            document.getElementById('displayBuyerEmail').textContent = currentUser.appUserEmail || "-";
        } else {
            // fallback
            document.getElementById('displayBuyerName').textContent = currentOrder.userName || "ë¹„íšŒì›";
            document.getElementById('displayBuyerEmail').textContent = "-";
        }

        document.getElementById('orderSection').style.display = 'block';
        document.getElementById('payBtn').disabled = false;
    }

    
    async function requestPortOnePayment() {
        if (!currentOrder || !portOneConfig.storeId) {
            alert("ì£¼ë¬¸ ì •ë³´ë‚˜ ê²°ì œ ì„¤ì •ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            return;
        }

        const buyerName = currentUser?.appUserName || currentOrder.userName || "êµ¬ë§¤ì";
        const buyerPhone = currentUser?.appUserMobile || currentOrder.userPhone || "010-0000-0000";
        const buyerEmail = currentUser?.appUserEmail || "test@example.com"; 

        // 1. Prepare Data for Server
        const prepareData = {
            order_id: currentOrder.orderId,
            payment_amount: Number(currentOrder.orderTotalPrice),
            payment_method: "CARD", // or selected method
            buyer_name: buyerName,
            buyer_email: buyerEmail,
            buyer_tel: buyerPhone,
            buyer_addr: currentOrder.orderAddressSnapshot || "",
            name: `CatchABite ì£¼ë¬¸ #${currentOrder.orderId}`
        };

        showLoading(true, "ê²°ì œ ì¤€ë¹„ ì¤‘...");

        try {
            // 2. Call Backend Prepare Endpoint
            const prepareResponse = await fetch('/api/payments/prepare', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(prepareData)
            });

            if (!prepareResponse.ok) {
                const errData = await prepareResponse.json();
                throw new Error(errData.errorMessage || "ê²°ì œ ì¤€ë¹„ ì‹¤íŒ¨");
            }

            const preparedData = await prepareResponse.json();
            console.log("ê²°ì œ ì¤€ë¹„ ì™„ë£Œ (Merchant UID):", preparedData.merchant_uid);

            // 3. Initiate PortOne Payment with Server Data
            // Note: Use the merchant_uid generated by the server
            const paymentId = `PAY-${currentOrder.orderId}-${Date.now()}`;
            
            const portOneRequest = {
                storeId: portOneConfig.storeId,
                channelKey: portOneConfig.channelKey,
                paymentId: paymentId,
                orderName: prepareData.name,
                totalAmount: prepareData.payment_amount,
                currency: "CURRENCY_KRW",
                payMethod: "CARD",
                customer: {
                    fullName: buyerName,
                    phoneNumber: buyerPhone,
                    email: buyerEmail,
                }
            };

            // Call PortOne SDK
            const response = await PortOne.requestPayment(portOneRequest);

            console.log("ê²°ì œ ì‘ë‹µ:", response);

            if (response.code != null) {
                showResult('error', `ê²°ì œ ì‹¤íŒ¨: ${response.message} (Code: ${response.code})`);
                return;
            }

            // 4. Verify Payment (Complete Step)
            // Pass the server-generated merchantUid
            await completePayment(response.paymentId, preparedData.merchant_uid);

        } catch (error) {
            console.error("ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì—ëŸ¬:", error);
            showResult('error', `ê²°ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ${error.message}`);
        } finally {
            // Only hide loading if we are not proceeding to completePayment (which handles its own loading)
            // But for safety, we can hide it here if an error occurred.
        }
    }
    
    // [Fixed] Payment Verification
    // Changed second parameter name from 'orderId' to 'merchantUid' to match what is actually passed
    async function completePayment(paymentId, merchantUid) {
        showLoading(true, "ê²°ì œ ê²€ì¦ ì¤‘ì…ë‹ˆë‹¤...");

        try {
            // âŒ Removed: const merchantUid = `ORDER_${orderId}`;
            // We now use the 'merchantUid' passed directly from the caller.

            // Send via Query Parameters
            const response = await fetch(`/api/payments/complete?paymentId=${paymentId}&merchantUid=${merchantUid}`, {
                method: "POST",
            });

            const result = await response.json();

            if (response.ok) {
                showResult('success', "ê²°ì œê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!", result);
                document.getElementById('payBtn').disabled = true;
            } else {
                showResult('error', `ê²€ì¦ ì‹¤íŒ¨: ${result.message || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"}`, result);
            }

        } catch (error) {
            console.error("ê²€ì¦ ìš”ì²­ ì‹¤íŒ¨:", error);
            showResult('error', "ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        } finally {
            showLoading(false);
        }
    }

    // UI ìœ í‹¸ë¦¬í‹°
    function showLoading(show, text = "ë¡œë”© ì¤‘...") {
        const el = document.getElementById('loading');
        if (show) {
            el.style.display = 'block';
            document.getElementById('loadingText').textContent = text;
        } else {
            el.style.display = 'none';
        }
    }

    function showResult(type, message, data = null) {
        const el = document.getElementById('result');
        el.className = `result ${type}`;
        el.style.display = 'block';
        
        let html = `<h3>${type === 'success' ? 'ì„±ê³µ' : 'ì˜¤ë¥˜'}</h3><p>${message}</p>`;
        if (data) {
            html += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        el.innerHTML = html;
    }

    function hideResult() {
        document.getElementById('result').style.display = 'none';
    }

    function resetForm() {
        window.location.reload();
    }
</script>

</body>
</html>